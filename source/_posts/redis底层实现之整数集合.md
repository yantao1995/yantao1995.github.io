title: redis底层实现之整数集合
author: Tany
tags:
  - redis
  - set
categories:
  - redis
date: 2020-09-15 17:16:00
---
阅读redis书籍《redis设计与实现》笔记。
源码版本redis 3.0。


<!-- more -->

### 整数集合intset

- 源码3.0    intset.h
- 集合键的底层实现之一

#### 结构

```
typedef struct intset {
  
    // 编码方式
    uint32_t encoding;

    // 集合包含的元素数量
    uint32_t length;

    // 保存元素的数组
    int8_t contents[];

} intset;
```

- contents：整数集合的每个元素都是 contents的一个元素item，各个项从小到大的顺序排列，不包含重复项。
- length：记录了整数集合包含的元素数量，即 contents 的长度。
- encoding：虽然contents是int8_t类型，但是保存的值类型取决于encoding。

编码类型范围：

```
int16_t   范围 [-32768,32767]
int32_t   范围 [-2147483648,2147483647]
int64_t   范围 [-9223372936854775808,9223372036854775807]
```

- 编码类型决定了contents数组内元素分配的空间大小
  `比如：int16_t编码， sizeof(int16_t)*5 = 16*5 = 80位`

#### 升级

- 概念：向一个int16_t数组的整数集合添加一个int64_t类型的整数值时，该整数集合的所有元素类型将会变成int64_t类型。
- 升级步骤：

  1. 根据新元素类型扩展整数集合底层数组空间大小，并为新元素分配空间。
  2. 转换现有所有元素转化类型后，依然保持有序。
  3. 新元素添加到指定位置。O(N)
- 升级后新元素的摆放位置:（因为引发升级的元素长度总比整数集合现有元素长度大，所以新元素在集合中要么最小，要么最大）：

  1. 最小情况，放置在整数集合的开头位置 （索引0）
  2. 最大情况，放置在整数集合的末尾位置 （索引 length-1）
- 作用：

  1. 提升整数集合的灵活性
     - C语言静态类型语言，为了避免错误，同一个数据结构保存同一类型
  2. 尽可能的节约内存
     - 不一开始就直接使用int64_t类型，在需要的时候才向长度大的方向扩展
- 不支持降级：升级了之后就算该引起升级的元素删除了，整数集合仍然不会降级